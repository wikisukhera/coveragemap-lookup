name: CoverageMap Lookup

on:
  workflow_dispatch:
    inputs:
      address:
        description: 'Optional address to search'
        required: false
      lat:
        description: 'Optional latitude'
        required: false
      lon:
        description: 'Optional longitude'
        required: false
      callback_url:
        description: 'n8n callback webhook URL'
        required: true
      callback_secret:
        description: 'callback secret'
        required: true

jobs:
  lookup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install dependencies
        run: |
          npm ci || npm i
          npm install playwright@1.40.0 minimist node-fetch@2 --no-save
          npx playwright install chromium

      - name: Run Playwright lookup
        env:
          ADDRESS: ${{ github.event.inputs.address || '' }}
          LAT: ${{ github.event.inputs.lat || '' }}
          LON: ${{ github.event.inputs.lon || '' }}
          CALLBACK_URL: ${{ github.event.inputs.callback_url }}
          CALLBACK_SECRET: ${{ github.event.inputs.callback_secret }}
        run: |
          node scripts/find_square_and_return.js
